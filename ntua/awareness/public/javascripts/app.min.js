///////////////////
// By Scienta, 2013
// http://scienta.dk
// 2013-03-21
var apiUrl="http://panic.image.ntua.gr:9000",devApiUrl="http://panic.image.ntua.gr",a;ObjectSearcher=function(){var e=this;e.objectList=ko.observableArray([]);e.droppedObject=ko.observable(null);e.showSearchPanel=ko.observable(false);e.filter=ko.observable('');e.filter.subscribe(function(a){e.searchFiles()});e.sourceList=[{title:'Europeana',key:'europeana'},{title:'DSP',key:'dsp'}];e.source=ko.observable(e.sourceList[0].key);e.source.subscribe(function(a){if(e.showSearchPanel()){e.searchFiles()}});e.term=ko.observable('');e.storedTerm='';e.searchCompleted=ko.observable(false);e.itemsCount=0;e.totalItems=ko.observable(0);e.pageNumber=ko.observable(1);e.objectsPerPage=6;e.hasPrevious=ko.computed(function(){return e.pageNumber()>1});e.hasNext=ko.computed(function(){return e.totalItems()>6*e.pageNumber()});e.changePage=function(b){a.storyList.previewObject(null);if(b<0&&e.pageNumber()>1){e.pageNumber(e.pageNumber()-1);e.searchFiles()}if(b>0&&e.pageNumber()<Math.ceil(e.totalItems()/e.itemsCount)){e.pageNumber(e.pageNumber()+1);e.searchFiles()}};e.searchFiles=function(){if(!e.term()){return}a.storyList.previewObject(null);e.showSearchPanel(true);e.searchCompleted(false);if(e.storedTerm!==e.term()+e.filter()+e.source()){e.pageNumber(1);e.storedTerm=e.term()+e.filter()+e.source()}e.objectList([]);var d=$.Deferred();if(e.source()=='dsp'){$.when(e.searchDSP()).then(function(){e.searchCompleted(true)})}else{$.when($.ajax({url:apiUrl+"/awareness/EuropeanaSearch/search",contentType:'application/json',type:"POST",data:ko.toJSON({pageNumber:e.pageNumber(),term:e.term(),type:e.filter()})}).pipe(function(b){var c=[];e.itemsCount=b.itemsCount;e.totalItems(b.totalResults);e.objectList([]);if(e.itemsCount>0){for(var i=b.items.length-1;i>=0;i--){switch(b.items[i].type){case'IMAGE':case'VIDEO':case'SOUND':case'TEXT':b.items[i].type=b.items[i].type.toLowerCase();break;case'_3D':b.items[i].type='3d';break;default:continue}c.push(e.objectList.unshift(new ForeignObject(b.items[i])))}}$.when.apply($,c).then(function(){a.user().fileFilter('files');a.user().showUserFilePanel(true);d.resolve()});return d.promise()}).fail(function(){d.resolve();alert(a.translation().errors.searchfailed)})).then(function(){e.searchCompleted(true)})}};e.searchDSP=function(){var d=$.Deferred();offset=(e.pageNumber()-1)*e.objectsPerPage;$.get(apiUrl+"/awareness/Search?theme="+a.selectedTheme().title+"&profile=image&query="+e.term()+'&start='+offset+'&max_results='+e.objectsPerPage).then(function(b){var c=[];e.totalItems(b.searchMeta.hits);e.itemsCount=b.searchMeta.count;e.objectList([]);if(e.itemsCount>0){for(i=b.images.length-1;i>=0;i--){b.images[i].type='image';c.push(e.objectList.unshift(new StoryObject(b.images[i])))}}$.when.apply($,c).always(function(){a.user().fileFilter('files');a.user().showUserFilePanel(true);d.resolve()})},function(){d.resolve();alert(a.translation().errors.searchfailed)});return d.promise()}};User=function(e){var f=this;if(e.id)f.id=e.id;if(e._id)f.id=e._id.$oid;f.username=ko.observable(e.username);f.email=ko.observable(e.email);f.role=ko.observable(e.role);f.objects=ko.observableArray([]);f.objectPage=ko.observable(1);f.objectsPerPage=5;f.objectsForPage=ko.computed(function(){start=(f.objectPage()-1)*f.objectsPerPage;return f.objects.slice(start,f.objectsPerPage+start)});f.stories=ko.observableArray([]);f.storyPage=ko.observable(1);f.storiesPerPage=5;f.storiesForPage=ko.computed(function(){start=(f.storyPage()-1)*f.storiesPerPage;return f.stories.slice(start,f.storiesPerPage+start)});f.showUserFilePanel=ko.observable(false);f.fileFilter=ko.observable('files');f.fileFilter.subscribe(function(){a.storyList.previewObject(null)});f.hasPrevious=ko.computed(function(){if(f.fileFilter()=='files')return f.objectPage()>1;return f.storyPage()>1});f.hasNext=ko.computed(function(){if(f.fileFilter()=='files')return f.objects().length>f.objectsPerPage*f.objectPage();return f.stories().length>f.storiesPerPage*f.storyPage()});f.showUserFilePanel.subscribe(function(b){if(b==true){f.loadLibrary();f.showUserUploadPanel(false)}a.storyList.previewObject(null)});f.showUserUploadPanel=ko.observable(false);f.showUserUploadPanel.subscribe(function(b){if(b==true){createUploader();f.showUserFilePanel(false)}a.storyList.previewObject(null)});f.changePage=function(b){a.storyList.previewObject(null);if(f.fileFilter()=='files'){if(b<0&&f.objectPage()>1){f.objectPage(f.objectPage()-1)}if(b>0&&f.objectPage()<Math.ceil(f.objects().length/f.objectsPerPage)){f.objectPage(f.objectPage()+1)}}else{if(b<0&&f.storyPage()>1){f.storyPage(f.storyPage()-1)}if(b>0&&f.storyPage()<Math.ceil(f.stories().length/f.storiesPerPage)){f.storyPage(f.storyPage()+1)}}};f.didLoadObjects=ko.observable(false);f.didLoadStories=ko.observable(false);f.loadLibrary=function(){var b=[];if(!f.didLoadObjects()){$.get(apiUrl+"/awareness/Users/"+f.id+"/objects").then(function(a){f.objects([]);for(var i=a.values.length-1;i>=0;i--){b.push(f.objects.unshift(new StoryObject(a.values[i])))}$.when.apply($,b).then(function(){f.didLoadObjects(true)})})}if(!f.didLoadStories()){$.get(apiUrl+"/awareness/Users/"+f.id+"/stories").then(function(a){f.stories([]);for(var i=a.values.length-1;i>=0;i--){a.values[i].creator=f.id;b.push(f.loadStory(a.values[i]))}$.when.apply($,b).then(function(){f.didLoadStories(true)})})}};f.loadStory=function(a){var b=$.Deferred(),story=new Story(a);$.when(story.loadObjects()).then(function(){f.stories.unshift(story);b.resolve()},function(){b.resolve()});return b.promise()};f.hasObject=function(a){if(a instanceof StoryObject){for(var i=f.objects().length-1;i>=0;i--){if(f.objects()[i].id==a.id){return true}}}return false};f.addObject=function(b){if(b instanceof StoryObject){if(f.hasObject(b)){return}e={title:b.title,description:b.description,provider:b.provider,dataProvider:b.dataProvider,url:b.url,thumbnail:b.thumbnail().indexOf("images/")==0?null:b.thumbnail(),type:b.type,license:b.license,dcCreator:b.author(),source:b.source,sosource:b.sosource,storyImage:b.storyImage()}}else{e={type:b.type,title:b.title,url:b.url,provider:b.provider,dataProvider:b.dataProvider,license:b.license,dcCreator:b.author(),source:b.source,sosource:b.sosource,europeanaid:b.europeanaid}}a.storyList.previewObject(null);newObject=new StoryObject(e);$.when(newObject.save()).then(function(){f.objects.unshift(newObject);f.fileFilter('files');f.showUserFilePanel(true)})};f.removeObject=function(b){if(b instanceof StoryObject&&confirm(a.translation().userfilepanel.deleteObjectConfirm)){$.ajax(apiUrl+"/awareness/digitalObjects/delete?id="+b.id,{contentType:'application/json',}).then(function(){f.objects.remove(b)});a.storyList.previewObject(null)}};f.removeObjectEverywhere=function(b){if(b instanceof StoryObject&&confirm(a.translation().userfilepanel.deleteObjectConfirm)){f.url=apiUrl+"/awareness/Admin/deleteObject?id="+b.id;if(b.sosource!=='Europeana'){f.url=apiUrl+"/awareness/StoryImages/delete?id="+b.storyImage()}$.ajax(f.url,{contentType:'application/json',}).then(function(){f.objects.remove(b)});a.storyList.previewObject(null)}};f.uploadFile=function(){if(!$('#upload_title').val()||!$('#upload_description').val()||!$('#uploadImage_upfile').val()){alert(a.translation().errors.objectuploadmissing);return}f.showUserUploadPanel(false);$.ajax({url:apiUrl+'/awareness/StoryImages/save',contentType:"application/json",type:'POST',data:ko.toJSON({title:$('#upload_title').val(),description:$('#upload_description').val(),original:$('#uploadImage_upfile').val(),originalName:$('#uploadImage_httpup').val()}),dataType:'json',success:function(d){f.didLoadObjects(false);f.showUserFilePanel(true)},error:function(b){alert(a.translation().errors.objectuploadfailed)}})};f.removeStory=function(b){if(b instanceof Story&&confirm(a.translation().userfilepanel.deleteStoryConfirm)){$.ajax(apiUrl+"/awareness/digitalStories/delete?id="+b.id,{contentType:'application/json',}).then(function(){a.storyList.selectedStory(null);a.storyBuilder.showStoryPanel(false);f.stories.remove(b);a.storyList.stories.remove(b);a.storyList.sortByProperty(a.storyList.sortedBy());alert(a.translation().userfilepanel.deleteStoryComplete)})}};f.save=function(b,c){var d=$.Deferred();error=false;if(!error&&f.username().length<3||!f.username().match(/^[a-zA-Z0-9\-_\.@]+$/)){error=true;alert(a.translation().errors.invalidusername)}if(!error&&f.email().length<1){error=true;alert(a.translation().errors.invalidemail)}if(!error&&!f.id&&b.length<6){error=true;alert(a.translation().errors.invalidpassword)}if(f.id&&!b){error=true;alert(a.translation().errors.passwordmissing)}e={username:f.username(),email:f.email(),role:f.role()};if(f.id){e.id=f.id}if(b){if(b!==c){error=true;alert(a.translation().errors.passwordmismatch)}e.password=b;e.password_confirmation=c}if(error){return d.reject()}$.ajax(apiUrl+"/awareness/Users/save",{contentType:'application/json',type:"POST",data:ko.toJSON(e)}).pipe(function(a){f.id=a.id;d.resolve()}).fail(function(){alert(a.translation().errors.usersavefailed);d.reject()});return d.promise()}};ForeignObject=function(a){var b=this;b.europeanaid=a.europeanaid;b.type=a.type;b.source=a.source;b.title=ko.observable(a.title);b.author=ko.observable(a.dcCreator?a.dcCreator:null);b.provider=a.provider;b.dataProvider=a.dataProvider;b.license=a.license;b.licenseArray=b.license?b.license.split(','):[];b.url=a.url;b.sosource='Europeana';b.isEditing=ko.observable(false)};ForeignObject.prototype.content=function(){var a=this;switch(a.type){case'image':case'video':case'sound':case'text':case'3d':if(typeof a.url=='undefined')return;return'<img src="'+a.url+'">';break;default:return'invalid';break}};ForeignObject.prototype.showPreview=function(b,c){var d=this;if(a.storyList.previewObject()==d){a.storyList.previewObject(null);return}a.storyList.previewObject(d);cube=$(c.target);left=cube.offset().left+(cube.width()/2);if(left+$('#object_preview').outerWidth()>$('body').innerWidth()){left-=$('#object_preview').outerWidth()}$('#object_preview').offset({left:left,top:cube.offset().top+(cube.height()/2)})};StoryObject=function(c,d){var e=this;e.title=ko.observable('');e.description=ko.observable('');e.provider='';e.creator=ko.observable(null);e.dcCreator='';e.dataProvider='';e.source=c.source?c.source:'';e.tags=c.tags?c.tags:[];e.type=c.type;e.url='';e.id=null;e.language='en';e.dateCreated=null;e.license='';e.licenseArray=[];e.sosource=c.sosource?c.sosource:'';e.thumbnail=ko.observable(null);e.europeanaid=c.europeanaid?c.europeanaid:'';e.storyImage=ko.observable(null);e.scriptPart=ko.observable('');e.scriptFilter=ko.computed({read:function(){return e.scriptPart().replace(/&lt;/g,'<').replace(/&gt;/g,'>')},write:function(a){e.scriptPart(a.replace(/</g,'&lt;').replace(/>/g,'&gt;'))},owner:this});e.story=d;e.isEditing=ko.observable(false);e.author=ko.observable('');e.setData=function(b){if(b._id)e.id=b._id.$oid;if(b.title)e.title(b.title);if(b.description)e.description(b.description);if(b.scriptPart)e.scriptPart(b.scriptPart);if(b.dcCreator)e.dcCreator=b.dcCreator;if(b.theme)e.theme=b.theme;if(b.language)e.language=b.language;if(b.license){e.license=b.license;e.licenseArray=e.license?e.license.split(','):[]}if(b.storyImage)e.storyImage(b.storyImage);if(b.url)e.url=b.url;if(b.thumbnail)e.thumbnail(b.thumbnail);if(b.objectPreview){e.url="../images/"+b.objectPreview;e.thumbnail("../images/"+b.objectThumbnail);e.storyImage(e.id)}if(b.dateCreated)e.dateCreated=Date.parse(b.dateCreated.$date.replace(/T/,' ').replace(/.\d{3}Z/,'').replace(/-/g,'/'));if(b.creator&&typeof b.creator!=='undefined'){e.creator(b.creator);if(a.loggedIn()&&e.creator()==a.user().id){e.author(a.user().username())}else{$.ajax(apiUrl+"/awareness/Users/"+b.creator,{contentType:'application/json',success:function(a){e.author(a.username)}})}}if(b.provider){e.provider=b.provider}if(b.dataProvider){e.dataProvider=b.dataProvider}};if(c){e.setData(c)}e.image=ko.computed(e.image,e);e.objectType=ko.computed(function(){return'object_'+e.type},e)};StoryObject.prototype.image=function(){var a=this;if(a.thumbnail()){return a.thumbnail()}return'images/cubes/cube_blank.png'};StoryObject.prototype.content=function(){var a=this;switch(a.type){case'image':case'video':case'sound':case'text':case'3d':if(typeof a.url=='undefined')return;return'<img src="'+a.url+'">';break;break;default:return'invalid';break}};StoryObject.prototype.showPreview=function(b,c){var d=this;if(a.storyList.previewObject()==d){d.isEditing(false);a.storyList.previewObject(null);return}a.storyList.previewObject(d);cube=$(c.target);left=cube.offset().left+(cube.width()/2);if(left+$('#object_preview').outerWidth()>$('body').innerWidth()){left-=$('#object_preview').outerWidth()}$('#object_preview').offset({left:left,top:cube.offset().top+(cube.height()/2)})};StoryObject.prototype.showScriptPreview=function(a,b){var c=this;c.showPreview(a,b);c.isEditing(true)};StoryObject.prototype.save=function(){var c=this;return $.ajax(apiUrl+"/awareness/digitalObjects/save",{contentType:'application/json',type:"POST",data:ko.toJSON({title:c.title(),description:c.description(),provider:c.provider,creator:a.user().id,dcCreator:c.dcCreator,dataProvider:c.dataProvider,source:c.source,type:c.type,url:c.url,language:c.language,license:c.license,sosource:c.sosource,thumbnail:c.thumbnail(),europeanaid:c.europeanaid,storyImage:c.storyImage()})}).pipe(function(a){c.setData(a)}).fail(function(b){if(b.responseText){alert(b.responseText)}else{alert(a.translation().errors.objectsavefailed)}})};StoryBuilder=function(){var d=this;d.newStory=ko.observable(new Story());d.showStoryPanel=ko.observable(false);d.showStoryPanel.subscribe(function(b){a.storyList.previewObject(null)});d.storyProgress=ko.observable(1);d.storyProgress.subscribe(function(b){if(b==2){a.user().fileFilter('files');a.user().showUserFilePanel(true);d.newStory().save()}});d.progressStory=function(a){if(a<0&&d.storyProgress()==2){d.storyProgress(d.storyProgress()-1)}if(a>0&&d.storyProgress()==1){d.storyProgress(d.storyProgress()+1)}};d.editStory=function(b){if(b==null){b=new Story();b.language(a.selectedLanguage());b.theme(a.selectedTheme().id);a.storyList.selectedStory(null)}d.newStory(b);d.storyProgress(1);d.showStoryPanel(true)};d.autoInsertStoryObject=function(b){slot=d.newStory().firstAvailableObjectSlot();if(slot<0){alert(a.translation().errors.storyFull);return}d.showStoryPanel(true);d.storyProgress(2);a.storyList.previewObject(false);d.insertStoryObject(b,slot)};d.insertStoryObject=function(b,c){if(typeof c=='undefined'){c=0}if(d.newStory().hasObject(b)){return}a.storyList.previewObject(false);b.story=d.newStory();d.newStory().objects.splice(c,1,b);setTimeout(function(){$('#storyBuilderGrid #objectId_'+b.id).click()},50);d.newStory().save()};d.removeStoryObject=function(b){if(typeof b=='undefined'){b=0}if(d.newStory().objects()[b])d.newStory().objects()[b].story=null;d.newStory().objects.splice(b,1,null);d.newStory().save();a.storyList.previewObject(false)};d.removeStoryObjectById=function(a){for(var i=d.newStory().objects().length-1;i>=0;i--){if(d.newStory().objects()[i]&&d.newStory().objects()[i].id==a){return d.removeStoryObject(i)}}}};Story=function(c){var d=this;d.id=null;d.firstObject=null;d.objects=ko.observableArray([]);d.comments=ko.observableArray([]);d.isPublished=ko.observable(false);d.isPublishable=ko.observable(false);d.selectedObject=ko.observable(null);d.selectedObject.subscribe(function(a){$('.objectcolumn iframe').attr('src','').hide()});d.creator=ko.observable(null);d.author=ko.observable('Unknown');d.coverImage=ko.observable(null);d.hasImage=ko.observable(false);d.likes=ko.observable(0);d.comments=ko.observableArray([]);d.title=ko.observable('');d.description=ko.observable('');d.descriptionFilter=ko.computed({read:function(){return d.description().replace(/&lt;/g,'<').replace(/&gt;/g,'>')},write:function(a){d.description(a.replace(/</g,'&lt;').replace(/>/g,'&gt;'))},owner:this});d.tags=ko.observableArray([]);d.tagsAsString=ko.computed({read:function(){return d.tags().join(', ')},write:function(a){d.tags(a.split(', '))}});d.theme=ko.observable();d.language=ko.observable();d.date='';d.license='';d.interactionPanel=ko.observable(null);d.rawData=null;var e=[];for(var i=0;i<12;i++){e[i]=null}d.objects(e);d.firstAvailableObjectSlot=function(){for(var i=0;i<d.objects().length;i++){if(d.objects()[i]==null){return i}};return-1};d.hasObject=function(a){if(a instanceof StoryObject){for(var i=d.objects().length-1;i>=0;i--){if(d.objects()[i]&&d.objects()[i].id==a.id){return true}}}return false};d.loadComments=function(){if(!d.id)return;$.get(apiUrl+"/awareness/digitalStories/"+d.id+"/comments").then(function(a){for(var i=a.values.length-1;i>=0;i--){d.comments.push(new StoryComment(a.values[i]))}})};d.addComment=function(){if(!$('#commentmessage').val()){return}c={text:$('#commentmessage').val(),userId:a.user().id,storyId:d.id};$.ajax(apiUrl+"/awareness/digitalStories/comments/save",{contentType:'application/json',type:"POST",data:ko.toJSON(c)}).pipe(function(a){$('#commentmessage').val('');d.comments.push(new StoryComment(a))})};d.removeComment=function(a){$.ajax(apiUrl+"/awareness/digitalStories/comments/delete?id="+a.id,{contentType:'application/json'}).then(function(){d.comments.remove(a)})};d.setData=function(b){d.id=b._id.$oid;d.title(b.title);d.description(b.description);d.theme(b.theme);d.language(b.language);d.license=b.license;d.isPublished(b.isPublished);d.isPublishable(b.isPublishable);if(b.tags)d.tags(b.tags);if(b.dateCreated)d.date=Date.parse(b.dateCreated.$date.replace(/T/,' ').replace(/.\d{3}Z/,'').replace(/-/g,'/'));if(b.creator&&typeof b.creator!=='undefined'){d.creator(b.creator);if(a.loggedIn()&&d.creator()==a.user().id){d.author(a.user().username())}else{$.ajax(apiUrl+"/awareness/Users/"+b.creator,{contentType:'application/json',success:function(a){d.author(a.username)}})}}};if(c){d.rawData=c;d.setData(c);d.loadComments()}d.canEdit=function(){if(!a.loggedIn())return false;if(d.creator()!=a.user().id&&a.user().role()=='contributor')return false;return true};d.loadObjects=function(){var b=$.Deferred(),requests=[];if(!d.rawData.storyObjects){return}for(var i=d.rawData.storyObjects.length-1;i>=0;i--){if(typeof d.rawData.storyObjects[i].StoryObjectID=='undefined'){continue}requests.push($.ajax({url:apiUrl+"/awareness/digitalObjects/"+d.rawData.storyObjects[i].StoryObjectID,type:"GET",index:i}).then(function(a){a.scriptPart=d.rawData.storyObjects[this.index].scriptPart;e[d.rawData.storyObjects[this.index].position]=new StoryObject(a,d);if(this.index==0){d.firstObject=e[d.rawData.storyObjects[this.index].position]}}))}$.when.apply($,requests).then(function(){d.objects(e);d.selectedObject(d.firstObject);b.resolve()},function(){b.resolve()});return b.promise()};d.flag=function(){};d.comment=function(){}};Story.prototype.navigateSelectedObject=function(a){var b=this;b.selectedObject(b.findNextObject(a,true))};Story.prototype.findNextObject=function(a,b){var c=this;currentIndex=c.objects.indexOf(c.selectedObject());var i=0;if(a>0){for(i=currentIndex+1;i<c.objects().length;i++){if(c.objects()[i]==null){continue}return c.objects()[i]};if(!b){return null}for(i=0;i<currentIndex;i++){if(c.objects()[i]==null){continue}return c.objects()[i]}}if(a<0){for(i=currentIndex-1;i>=0;i--){if(c.objects()[i]==null){continue}return c.objects()[i]};if(!b){return null}for(i=c.objects().length;i>=currentIndex;i--){if(c.objects()[i]==null){continue}return c.objects()[i]}}};Story.prototype.save=function(){var c=this;if(!c.creator()){if(!a.loggedIn){alert(a.translation().errors.notloggedin);return}c.creator(a.user().id)}data={title:c.title,description:c.description,tags:c.tags,creator:c.creator(),theme:c.theme(),language:c.language(),isPublished:c.isPublished(),isPublishable:c.isPublishable(),storyObjects:c.serializedObjects()};if(c.id){data._id=c.id}return $.ajax(apiUrl+"/awareness/digitalStories/save",{contentType:'application/json',type:"POST",data:ko.toJSON(data)}).pipe(function(b){if(!c.id){a.user().stories.unshift(c)}c.setData(b)})};Story.prototype.publish=function(){var b=this;if(b.isPublishable()){if(!b.isPublished()){if(b.theme()==a.selectedTheme().id){a.storyList.stories.unshift(b);a.storyList.sortByProperty(a.storyList.sortedBy())}else{a.selectedTheme(ko.utils.arrayFirst(a.themes(),function(a){return a.id==b.theme()}))}}a.storyBuilder.showStoryPanel(false);a.user().showUserFilePanel(false);a.storyList.selectedStory(null);b.isPublished(true);b.save()}};Story.prototype.serializedObjects=function(){var a=this;data=[];for(var i=a.objects().length-1;i>=0;i--){if(a.objects()[i]==null){continue}data.unshift({StoryObjectID:a.objects()[i].id,position:i,order:i,scriptPart:a.objects()[i].scriptPart()})};return data};Story.prototype.objectCount=function(){var a=this;count=0;for(var i=a.objects().length-1;i>=0;i--){if(a.objects()[i]==null){continue}count++};return count};StoryComment=function(c){var d=this;d.id;d.userId=ko.observable();d.storyId=ko.observable();d.text=ko.observable();d.dateCreated;d.dateFormated=ko.computed({read:function(){return new Date(d.dateCreated).toLocaleDateString()},deferEvaluation:true});d.author=ko.observable('');d.setData=function(b){if(b._id)d.id=b._id.$oid;if(b.storyId)d.storyId(b.storyId);if(b.text)d.text(b.text);if(b.dateCreated)d.dateCreated=Date.parse(b.dateCreated.$date.replace(/T/,' ').replace(/.\d{3}Z/,'').replace(/-/g,'/'));if(b.userId){d.userId(b.userId);if(a.loggedIn()&&d.userId()==a.user().id){d.author(a.user().username());return}$.ajax(apiUrl+"/awareness/Users/"+d.userId(),{contentType:'application/json',success:function(a){d.author(a.username)}})}};if(c){d.setData(c)}d.canRemove=ko.computed(function(){if(!a.loggedIn())return false;if(d.userId()!=a.user().id&&a.user().role()=='contributor')return false;return true})};StoryList=function(){var e=this;e.term=ko.observable('');e.storedTerm=null;e.totalStories=0;e.searchCompleted=ko.observable(false);e.hideStories=ko.observable(true);e.searchCompleted.subscribe(function(a){if(a){e.sortByProperty(e.sortedBy())}else if(e.hideStories()){$('#stories').hide()}});e.sortedBy=ko.observable('date');e.storyOffset=ko.observable(0);e.storedOffset=null;e.storiesPerPage=16;e.stories=ko.observableArray([]);e.selectedStory=ko.observable(null);e.previewedObject=ko.observable(null);e.previewObject=ko.computed({read:function(){return e.previewedObject()},write:function(b){if(!b&&e.previewedObject.peek()){if(e.previewedObject().isEditing()){a.storyBuilder.newStory().save()}e.previewedObject().isEditing(false)}$('#object_preview_player iframe').attr('src','').hide();e.previewedObject(b)}});e.loadNext=function(){if(e.storyOffset()+e.storiesPerPage<e.totalStories){e.hideStories(false);e.storyOffset(e.storyOffset()+e.storiesPerPage);e.searchStories();e.hideStories(true)}};e.reloadStories=function(){e.storedTerm=null;e.selectedStory(null);e.previewObject(null);e.storyOffset(0);e.stories([]);e.searchStories()};e.clearSearch=function(){e.term('');e.searchStories()};e.searchStories=function(){if(e.storedTerm==e.term()&&e.storedOffset==e.storyOffset()){return}if(e.storedOffset!=e.storyOffset()){e.storedOffset=e.storyOffset()}if(e.storedTerm!=e.term()){e.storedTerm=e.term();e.selectedStory(null);e.previewObject(null);e.stories([]);e.storyOffset(0)}e.searchCompleted(false);if(e.term()==''){return e.loadStories()}var c=$.Deferred();$.get(apiUrl+"/awareness/Search?theme="+a.selectedTheme().title+"&profile=story&query="+e.term()+'&start='+e.storyOffset()+'&max_results='+e.storiesPerPage).then(function(a){e.totalStories=a.searchMeta.hits;var b=[];for(i=a.digitalStories.length-1;i>=0;i--){b.push(e.loadStory(a.digitalStories[i].id))};$.when.apply($,b).always(function(){e.searchCompleted(true);c.resolve()})},function(){e.searchCompleted(true);alert(a.translation().errors.storyloadfailed)});return c.promise()};e.loadStories=function(){e.searchCompleted(false);var c=$.Deferred();$.get(apiUrl+"/awareness/Themes/"+a.selectedTheme().id+"/stories?from="+e.storyOffset()+'&to='+(e.storyOffset()+e.storiesPerPage)).then(function(a){e.totalStories=a.totalSize;var b=[];for(i=a.stories.length-1;i>=0;i--){b.push(e.loadStory(a.stories[i].id))};$.when.apply($,b).always(function(){e.searchCompleted(true);c.resolve()})},function(){e.searchCompleted(true);alert(a.translation().errors.storyloadfailed)});return c.promise()};e.loadStory=function(c){var d=$.Deferred();$.get(apiUrl+"/awareness/digitalStories/"+c).then(function(a){if(!a.storyObjects){return d.resolve()}var b=new Story(a);$.when(b.loadObjects()).then(function(){if(a.coverImage){b.coverImage(new StoryObject({url:a.coverImage}),e)}e.stories.push(b);d.resolve()},function(){d.resolve()})},function(){d.resolve()});return d.promise()};e.selectStoryById=function(d){if(e.selectedStory()&&e.selectedStory().id==d){return}for(var i=e.stories().length-1;i>=0;i--){if(e.stories()[i].id==d){return e.selectedStory(e.stories()[i])}};$.get(apiUrl+"/awareness/digitalStories/"+d).then(function(b){if(!b.storyObjects){return}var c=new Story(b);if(!c.isPublished()){if(!a.loggedIn()){return e.selectedStory(null)}else if(c.creator()!==a.user().id){return e.selectedStory(null)}}$.when(c.loadObjects()).then(function(){e.selectedStory(c)})})};e.sortByProperty=function(a){e.sortedBy(a);e.stories.sortBy(a);$('#stories').imagesLoaded(function(){$('#stories').show();$('#stories').masonry('reload')})};e.shareStory=function(b){if(b=='twitter'){window.open("https://twitter.com/intent/tweet?url="+encodeURIComponent(location.href)+"&text="+encodeURI(a.translation().interactionpanel.tweetText+" '"+e.selectedStory().title()+"'"),"Share on Twitter","width=550,height=420,scrollbars=no")}if(b=='facebook'){window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(location.href),"Share on Facebook","width=550,height=420,scrollbars=no")}$('.sharepanel').toggle()}};function App(){var f=this;f.twoColumnPlayer=ko.observable(false);f.resizeHandler=function(){var a;clearTimeout(a);a=setTimeout(function(){extraHeight=0;if($(window).width()<1003||(window.orientation==0||window.orientation==180)){$('.container').css('maxWidth','671px');$('#toolbars').css('maxWidth','664px');$('#toolbar_last').css('clear','both');$('#player').css('width','657px');$('#genericpanel').css('width','657px');f.twoColumnPlayer(false);extraHeight=33}else if($(window).width()<1335||(window.orientation==90||window.orientation==-90)){$('.container').css('maxWidth','1003px');$('#toolbars').css('maxWidth','996px');$('#toolbar_last').css('clear','none');$('#player').css('width','989px');$('#genericpanel').css('width','989px');f.twoColumnPlayer(true)}else{$('.container').css('maxWidth','1335px');$('#toolbars').css('maxWidth','1328px');$('#toolbar_last').css('clear','none');$('#player').css('width','989px');$('#genericpanel').css('width','989px');f.twoColumnPlayer(true)}if(f.loggedIn()){$('#toolbarfiller').height(109+extraHeight);if($(window).width()<1003||$(window).width()>=1335){$('#toolbar_empty').show()}else{$('#toolbar_empty').hide()}}else{$('#toolbarfiller').height(76);$('#toolbar_empty').hide()}},100)};f.resizeHandler();$('.content').css('minHeight',$('.container').height()-$('.banner').height()-20);$(window).bind('resize',f.resizeHandler);$(window).scroll(function(e){$el=$('#toolbars');if($(this).scrollTop()>$('.banner').height()+20&&$el.css('position')!='fixed'){$('#toolbars').css({'position':'fixed','top':'0px'});$('#player').css({'position':'fixed','top':$('#toolbars').height()+7});$('#genericpanel').css({'position':'fixed','top':$('#toolbars').height()+7})}else if($(this).scrollTop()<=$('.banner').height()+20&&$el.css('position')=='fixed'){$('#toolbars').css({'position':'static'});$('#player').css({'position':'absolute','top':'auto'});$('#genericpanel').css({'position':'absolute','top':'auto'})}if($(this).scrollTop()==$(document).height()-$(window).height()){f.storyList.loadNext()}});f.translations={};f.translation=ko.observable({name:'en',story:{},toolbar:{},searchpanel:{filter:{}},userfilepanel:{filter:{}},storypanel:{},interactionpanel:{}});f.selectedLanguage=ko.observable('en');f.loadLanguage=function(b){if(!f.translations[b]){return $.getJSON('javascripts/language/'+b+'.js',function(a){f.translations[b]=a;f.translation(f.translations[b])})}else{return f.translation(f.translations[b])}};f.themes=ko.observableArray([]);f.defaultTheme=null;f.loadThemes=function(){return $.get(apiUrl+"/awareness/Themes/list").then(function(b){var c=$.Deferred(),requests=[];for(var i=b.values.length-1;i>=0;i--){requests.push($.get(apiUrl+"/awareness/Themes/"+b.values[i].id).then(function(a){if(a.defaultTheme){f.defaultTheme=f.themes().length}f.themes.push(a)}))}$.when.apply($,requests).then(function(){c.resolve()});return c.promise()})};f.selectedTheme=ko.observable();f.previousTheme=null;f.selectedTheme.subscribe(function(a){if(typeof a=='object')f.previousTheme=a},this,"beforeChange");f.selectedTheme.subscribe(function(a){if(!a||f.previousTheme==a){return}if(f.didLoad()){f.previousTheme=a;f.storyList.reloadStories()}$('.background img').attr('src','../images/'+a.wallpaper);$('.banner img').attr('src','../images/'+a.banner)});f.storyList=new StoryList();$('#stories').masonry({itemSelector:'.storybox'});f.didLoad=ko.observable(false);ko.computed(function(){if(!f.didLoad()){return}value=null;if(f.selectedLanguage()){value='/'+f.selectedLanguage()}if(f.selectedTheme()){value+='/'+encodeURI(f.selectedTheme().title).replace(/%20/g,"+")}if(f.storyList.selectedStory()){value+='/'+f.storyList.selectedStory().id}if(value){location.hash=value}},f).extend({throttle:1});f.goHome=function(){f.storyList.clearSearch();f.storyBuilder.showStoryPanel(false);f.objectSearcher.showSearchPanel(false);f.storyList.previewObject(null);f.user().showUserFilePanel(false);f.storyList.selectedStory(null)};f.storyBuilder=new StoryBuilder();f.objectSearcher=new ObjectSearcher();f.selectedPanel=ko.observable(null);f.genericPanel=ko.computed(function(){if(f.selectedPanel()=='contact'){return f.translation().contactpanel}if(f.selectedPanel()=='about'){return f.translation().aboutpanel}if(f.selectedPanel()=='help'){return f.translation().helppanel}if(f.selectedPanel()=='register'){f.showLoginPanel(false);return f.translation().registerpanel}if(f.selectedPanel()=='profile'){return f.translation().profilepanel}return null});if(!$.cookie('firstLoad')){f.selectedPanel('help');$.cookie('firstLoad','1',{expires:70})}f.genericPanelScroll=function(a){if(!f.genericPanel().columns){return}if(a>0){$('#scroller').scrollLeft(Math.min($('#scroller').scrollLeft()+325,$('#scroller div').width()))}if(a<0){$('#scroller').scrollLeft(Math.max($('#scroller').scrollLeft()-325,0))}};f.showLoginPanel=ko.observable(false);f.user=ko.observable(null);f.loggedIn=ko.observable(false);f.loggedIn.subscribe(function(a){if(a){f.user().loadLibrary()}});f.login=function(d){$.ajax(apiUrl+"/awareness/Users/login",{contentType:'application/json',type:"POST",data:ko.toJSON({email:$('#login_email').val(),password:$('#login_password').val()}),success:function(a){f.user(new User(a));f.loggedIn(true);f.resizeHandler();f.showLoginPanel(false);f.selectedPanel(null)},error:function(a,b,c){alert(a.responseText)}})};f.logout=function(){$.get(apiUrl+"/awareness/session/logout");f.loggedIn(false);f.user(null);f.resizeHandler()};f.register=function(){if(!$('#register_acceptterms').is(':checked')){alert(a.translation().errors.invalidterms);return}data={id:null,username:$('#register_username').val(),email:$('#register_email').val(),role:"contributor"};user=new User(data);$.when(user.save($('#register_password').val(),$('#register_passwordconfirmation').val())).then(function(){f.user(user);f.loggedIn(true);f.resizeHandler();f.selectedPanel(null)})};f.profile=function(){$.when(f.user().save($('#profile_password').val(),$('#profile_passwordconfirmation').val())).then(function(){f.selectedPanel(null)})};ko.computed(function(){if(f.storyList.selectedStory()){if(f.loggedIn()){f.user().showUserFilePanel(false)}f.storyBuilder.showStoryPanel(false);f.objectSearcher.showSearchPanel(false);f.storyList.previewObject(null)}},f);f.loadLanguage('en');$.when(f.loadThemes()).then(function(){Path.map("#/:language/:theme").to(function(){f.loadLanguage(this.params['language']);f.selectedLanguage(this.params['language']);var b=decodeURI(this.params['theme']).replace(/\+/g," ");f.selectedTheme(ko.utils.arrayFirst(f.themes(),function(a){return a.title==b}))});Path.map("#/:language/:theme/:story").to(function(){f.loadLanguage(this.params['language']);f.selectedLanguage(this.params['language']);var b=decodeURI(this.params['theme']).replace(/\+/g," ");f.selectedTheme(ko.utils.arrayFirst(f.themes(),function(a){return a.title==b}));f.storyList.selectStoryById(this.params['story'])});$.ajax({url:apiUrl+"/awareness/session/user",contentType:'application/json',dataType:'json'}).then(function(a){f.user(new User(a));f.loggedIn(true);f.resizeHandler();f.showLoginPanel(false)});$('.loader').fadeOut();$.when(f.storyList.searchStories()).always(function(){f.didLoad(true);f.resizeHandler();if(f.defaultTheme){Path.root("#/en/"+f.themes()[f.defaultTheme].title)}else{Path.root("#/en/")}Path.listen()})},function(){alert(a.translation().errors.themeloadfailed)})};ko.observableArray.fn.sortBy=function(c){this.sort(function(a,b){if(a[c]<b[c])return 1;if(a[c]>b[c])return-1;return 0})};(function(){var g,_noOp=function(){};ko.bindingHandlers.drag={init:function(b,c,d){var e=c().dragOptions||{};e.appendTo='body';e.helper=e.helper||'clone';e.snapMode='inner';e.revert='invalid';e.revertDuration=200;e.zIndex=25000;e.start=function(){g=ko.utils.unwrapObservable(c().value);if(g instanceof ForeignObject||g instanceof StoryObject){a.storyList.previewObject(null)}};$(b).draggable(e).disableSelection()}};ko.bindingHandlers.drop={init:function(c,d,e){var f=d().dropOptions||{};f.drop=function(a,b){if(g==null){return}if(typeof d().objectIndex!=='undefined'){d().value(g,d().objectIndex,a)}else{d().value(g,a)}g=null};$(c).droppable(f)}};ko.observableArray.fn.pushAll=function(a){var b=this();this.valueWillMutate();ko.utils.arrayPushAll(b,a);this.valueHasMutated();return this}})();function createUploader(){var a=new qq.FileUploader({element:document.getElementById('uploadImage'),action:apiUrl+'/awareness/FileReader/save',allowedExtensions:['jpg','jpeg','png','gif'],sizeLimit:4194304,debug:true})};$(function(){a=new App();ko.applyBindings(a)});